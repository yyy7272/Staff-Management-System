<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Authentication</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        button { margin: 10px 0; padding: 10px 20px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Authentication Test</h1>

        <h2>1. Login</h2>
        <button onclick="testLogin()">Login as Admin</button>
        <div id="login-result" class="result"></div>

        <h2>2. Test APIs</h2>
        <button onclick="testEmployeeAPI()">Test Employee API</button>
        <button onclick="testGroupAPI()">Test Group API</button>
        <button onclick="testSharedFileAPI()">Test SharedFile API</button>
        <div id="api-result" class="result"></div>

        <h2>3. Token Info</h2>
        <button onclick="showTokenInfo()">Show Token Info</button>
        <div id="token-result" class="result"></div>

        <h2>4. Clear Token</h2>
        <button onclick="clearToken()">Clear Token</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';

        async function testLogin() {
            const result = document.getElementById('login-result');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'Admin123!@#'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('authToken', data.token);
                    result.className = 'result success';
                    result.innerHTML = `Login successful! Token stored. User: ${data.user.username}`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `Login failed: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Login error: ${error.message}`;
            }
        }

        async function testEmployeeAPI() {
            const result = document.getElementById('api-result');
            const token = localStorage.getItem('authToken');

            if (!token) {
                result.className = 'result error';
                result.innerHTML = 'No token found. Please login first.';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/Employee`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `Employee API success! Found ${data.data.length} employees.`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `Employee API failed: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Employee API error: ${error.message}`;
            }
        }

        async function testGroupAPI() {
            const result = document.getElementById('api-result');
            const token = localStorage.getItem('authToken');

            if (!token) {
                result.className = 'result error';
                result.innerHTML = 'No token found. Please login first.';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/Group`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `Group API success! Found ${data.data.length} groups.`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `Group API failed: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `Group API error: ${error.message}`;
            }
        }

        async function testSharedFileAPI() {
            const result = document.getElementById('api-result');
            const token = localStorage.getItem('authToken');

            if (!token) {
                result.className = 'result error';
                result.innerHTML = 'No token found. Please login first.';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/SharedFile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    result.className = 'result success';
                    result.innerHTML = `SharedFile API success! Found ${data.data.length} files.`;
                } else {
                    result.className = 'result error';
                    result.innerHTML = `SharedFile API failed: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.innerHTML = `SharedFile API error: ${error.message}`;
            }
        }

        function showTokenInfo() {
            const result = document.getElementById('token-result');
            const token = localStorage.getItem('authToken');

            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const expiry = new Date(payload.exp * 1000);
                    const isExpired = expiry < new Date();

                    result.className = isExpired ? 'result error' : 'result success';
                    result.innerHTML = `
                        <strong>Token Info:</strong><br>
                        User: ${payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name']}<br>
                        Email: ${payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress']}<br>
                        Expires: ${expiry.toLocaleString()}<br>
                        Status: ${isExpired ? 'EXPIRED' : 'Valid'}
                    `;
                } catch (error) {
                    result.className = 'result error';
                    result.innerHTML = `Token parsing error: ${error.message}`;
                }
            } else {
                result.className = 'result error';
                result.innerHTML = 'No token found in localStorage';
            }
        }

        function clearToken() {
            localStorage.removeItem('authToken');
            sessionStorage.removeItem('authToken');
            const result = document.getElementById('token-result');
            result.className = 'result success';
            result.innerHTML = 'Token cleared from storage';
        }
    </script>
</body>
</html>