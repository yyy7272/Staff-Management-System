<!DOCTYPE html>
<html>
<head>
    <title>Collaboration Test</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
</head>
<body>
    <h1>Collaboration System Test</h1>
    <div id="status">Disconnected</div>
    <div id="log"></div>
    
    <script>
        const token = 'eyJhbGciOiJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGRzaWctbW9yZSNobWFjLXNoYTUxMiIsInR5cCI6IkpXVCJ9.eyJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9uYW1lIjoiYWRtaW4iLCJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcy9lbWFpbGFkZHJlc3MiOiJhZG1pbkBjb21wYW55LmNvbSIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiMWFjZTJjM2EtYTk1ZC00MzVkLWI5ODktOTBlNTI2MGQzOTFlIiwiaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcy9yb2xlIjoiVXNlciIsImV4cCI6MTc1NzE2MjQ4NSwiaXNzIjoiU3RhZmZNYW5hZ2VtZW50U3lzdGVtIiwiYXVkIjoiU3RhZmZNYW5hZ2VtZW50U3lzdGVtVXNlcnMifQ.v-OFGUVjL7WzrrNDTQmLt-oyMhOzW7yiTXDBOzgVgLsWJLSeZb7D_HWe9wj0rVkTuGjYVBVWS9y1GV7utV0e-w';
        
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5000/collaborationHub", {
                accessTokenFactory: () => token,
                transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.ServerSentEvents
            })
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        function log(message) {
            console.log(message);
            document.getElementById('log').innerHTML += '<div>' + new Date().toISOString() + ': ' + message + '</div>';
        }

        connection.start().then(function () {
            document.getElementById('status').textContent = 'Connected';
            log('Connected to SignalR hub successfully!');
            
            // Test joining a session
            return connection.invoke('JoinSession', 'Employee', '6f1e843f-a738-4635-881b-bdd16ecf4fb5');
        }).then(function () {
            log('Successfully joined collaboration session');
            
            // Add small delay to ensure session is fully established
            return new Promise(resolve => setTimeout(resolve, 100));
        }).then(function () {
            // Test field locking
            return connection.invoke('LockField', 'Employee', '6f1e843f-a738-4635-881b-bdd16ecf4fb5', 'Name');
        }).then(function () {
            log('Successfully locked field');
            
            // Test typing indicator
            return connection.invoke('StartTyping', 'Employee', '6f1e843f-a738-4635-881b-bdd16ecf4fb5', 'Name');
        }).then(function () {
            log('Successfully started typing indicator');
        }).catch(function (err) {
            document.getElementById('status').textContent = 'Error';
            log('Error: ' + err.toString());
        });

        // Listen for server events
        connection.on('UserJoined', function (entityType, entityId, user) {
            log('User joined: ' + user.userName + ' in ' + entityType + ':' + entityId);
        });

        connection.on('FieldLocked', function (entityType, entityId, fieldName, userId, userName) {
            log('Field locked: ' + fieldName + ' by ' + userName);
        });

        connection.on('UserTyping', function (entityType, entityId, fieldName, userId, userName) {
            log('User typing: ' + userName + ' in field ' + fieldName);
        });
    </script>
</body>
</html>